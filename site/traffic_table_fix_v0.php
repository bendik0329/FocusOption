<?php 

require ('common/database.php');
$rowsInBatch= 50000;
$couner = 0 ;

$debug = isset($_GET['debug']) ? $_GET['debug'] : 0;


$runThisThing = true;

$wherePart = "";


$q = "CREATE TABLE traffic2 SELECT * FROM traffic LIMIT 0;";
mysql_query($q);

$q = "ALTER TABLE `traffic2` DEFAULT CHARSET=utf8 COLLATE utf8_general_ci;";
mysql_query($q);
$q = "ALTER TABLE traffic2 MODIFY id int NOT NULL AUTO_INCREMENT;";

mysql_query($q);
$q = "ALTER TABLE `traffic2` ADD `unixRdate` INT(10) NOT NULL , ADD INDEX `unixdate` (`unixRdate`);";

mysql_query($q);



$q  = 
'
ALTER TABLE `traffic2`
PARTITION BY RANGE(unixRdate) (
PARTITION p0 VALUES LESS THAN (UNIX_TIMESTAMP("2016-06-20 00:00:00")),
PARTITION p1 VALUES LESS THAN (UNIX_TIMESTAMP("2016-06-27 00:00:00")),
PARTITION p2 VALUES LESS THAN (UNIX_TIMESTAMP("2016-07-04 00:00:00")),
PARTITION p3 VALUES LESS THAN (UNIX_TIMESTAMP("2016-07-11 00:00:00")),
PARTITION p4 VALUES LESS THAN (UNIX_TIMESTAMP("2016-07-18 00:00:00")),
PARTITION p5 VALUES LESS THAN (UNIX_TIMESTAMP("2016-07-25 00:00:00")),
PARTITION p6 VALUES LESS THAN (UNIX_TIMESTAMP("2016-08-01 00:00:00")),
PARTITION p7 VALUES LESS THAN (UNIX_TIMESTAMP("2016-08-08 00:00:00")),
PARTITION p8 VALUES LESS THAN (UNIX_TIMESTAMP("2016-08-15 00:00:00")),
PARTITION p9 VALUES LESS THAN (UNIX_TIMESTAMP("2016-08-22 00:00:00")),
PARTITION p10 VALUES LESS THAN (UNIX_TIMESTAMP("2016-08-29 00:00:00")),
PARTITION p11 VALUES LESS THAN (UNIX_TIMESTAMP("2016-09-05 00:00:00")),
PARTITION p12 VALUES LESS THAN (UNIX_TIMESTAMP("2016-09-12 00:00:00")),
PARTITION p13 VALUES LESS THAN (UNIX_TIMESTAMP("2016-09-19 00:00:00")),
PARTITION p14 VALUES LESS THAN (UNIX_TIMESTAMP("2016-09-26 00:00:00")),
PARTITION p15 VALUES LESS THAN (UNIX_TIMESTAMP("2016-10-03 00:00:00")),
PARTITION p16 VALUES LESS THAN (UNIX_TIMESTAMP("2016-10-10 00:00:00")),
PARTITION p17 VALUES LESS THAN (UNIX_TIMESTAMP("2016-10-17 00:00:00")),
PARTITION p18 VALUES LESS THAN (UNIX_TIMESTAMP("2016-10-24 00:00:00")),
PARTITION p19 VALUES LESS THAN (UNIX_TIMESTAMP("2016-10-31 00:00:00")),
PARTITION p20 VALUES LESS THAN (UNIX_TIMESTAMP("2016-11-07 00:00:00")),
PARTITION p21 VALUES LESS THAN (UNIX_TIMESTAMP("2016-11-14 00:00:00")),
PARTITION p22 VALUES LESS THAN (UNIX_TIMESTAMP("2016-11-21 00:00:00")),
PARTITION p23 VALUES LESS THAN (UNIX_TIMESTAMP("2016-11-28 00:00:00")),
PARTITION p24 VALUES LESS THAN (UNIX_TIMESTAMP("2016-12-05 00:00:00")),
PARTITION p25 VALUES LESS THAN (UNIX_TIMESTAMP("2016-12-12 00:00:00")),
PARTITION p26 VALUES LESS THAN (UNIX_TIMESTAMP("2016-12-19 00:00:00")),
PARTITION p27 VALUES LESS THAN (UNIX_TIMESTAMP("2016-12-26 00:00:00")),
PARTITION p28 VALUES LESS THAN (UNIX_TIMESTAMP("2017-01-02 00:00:00")),
PARTITION p29 VALUES LESS THAN (UNIX_TIMESTAMP("2017-01-09 00:00:00")),
PARTITION p30 VALUES LESS THAN (UNIX_TIMESTAMP("2017-01-16 00:00:00")),
PARTITION p31 VALUES LESS THAN (UNIX_TIMESTAMP("2017-01-23 00:00:00")),
PARTITION p32 VALUES LESS THAN (UNIX_TIMESTAMP("2017-01-30 00:00:00")),
PARTITION p33 VALUES LESS THAN (UNIX_TIMESTAMP("2017-02-06 00:00:00")),
PARTITION p34 VALUES LESS THAN (UNIX_TIMESTAMP("2017-02-13 00:00:00")),
PARTITION p35 VALUES LESS THAN (UNIX_TIMESTAMP("2017-02-20 00:00:00")),
PARTITION p36 VALUES LESS THAN (UNIX_TIMESTAMP("2017-02-27 00:00:00")),
PARTITION p37 VALUES LESS THAN (UNIX_TIMESTAMP("2017-03-06 00:00:00")),
PARTITION p38 VALUES LESS THAN (UNIX_TIMESTAMP("2017-03-13 00:00:00")),
PARTITION p39 VALUES LESS THAN (UNIX_TIMESTAMP("2017-03-20 00:00:00")),
PARTITION p40 VALUES LESS THAN (UNIX_TIMESTAMP("2017-03-27 00:00:00")),
PARTITION p41 VALUES LESS THAN (UNIX_TIMESTAMP("2017-04-03 00:00:00")),
PARTITION p42 VALUES LESS THAN (UNIX_TIMESTAMP("2017-04-10 00:00:00")),
PARTITION p43 VALUES LESS THAN (UNIX_TIMESTAMP("2017-04-17 00:00:00")),
PARTITION p44 VALUES LESS THAN (UNIX_TIMESTAMP("2017-04-24 00:00:00")),
PARTITION p45 VALUES LESS THAN (UNIX_TIMESTAMP("2017-05-01 00:00:00")),
PARTITION p46 VALUES LESS THAN (UNIX_TIMESTAMP("2017-05-08 00:00:00")),
PARTITION p47 VALUES LESS THAN (UNIX_TIMESTAMP("2017-05-15 00:00:00")),
PARTITION p48 VALUES LESS THAN (UNIX_TIMESTAMP("2017-05-22 00:00:00")),
PARTITION p49 VALUES LESS THAN (UNIX_TIMESTAMP("2017-05-29 00:00:00")),
PARTITION p50 VALUES LESS THAN (UNIX_TIMESTAMP("2017-06-05 00:00:00")),
PARTITION p51 VALUES LESS THAN (UNIX_TIMESTAMP("2017-06-12 00:00:00")),
PARTITION p52 VALUES LESS THAN (UNIX_TIMESTAMP("2017-06-19 00:00:00")),
PARTITION p53 VALUES LESS THAN (UNIX_TIMESTAMP("2017-06-26 00:00:00")),
PARTITION p54 VALUES LESS THAN (UNIX_TIMESTAMP("2017-07-03 00:00:00")),
PARTITION p55 VALUES LESS THAN (UNIX_TIMESTAMP("2017-07-10 00:00:00")),
PARTITION p56 VALUES LESS THAN (UNIX_TIMESTAMP("2017-07-17 00:00:00")),
PARTITION p57 VALUES LESS THAN (UNIX_TIMESTAMP("2017-07-24 00:00:00")),
PARTITION p58 VALUES LESS THAN (UNIX_TIMESTAMP("2017-07-31 00:00:00")),
PARTITION p59 VALUES LESS THAN (UNIX_TIMESTAMP("2017-08-07 00:00:00")),
PARTITION p60 VALUES LESS THAN (UNIX_TIMESTAMP("2017-08-14 00:00:00")),
PARTITION p61 VALUES LESS THAN (UNIX_TIMESTAMP("2017-08-21 00:00:00")),
PARTITION p62 VALUES LESS THAN (UNIX_TIMESTAMP("2017-08-28 00:00:00")),
PARTITION p63 VALUES LESS THAN (UNIX_TIMESTAMP("2017-09-04 00:00:00")),
PARTITION p64 VALUES LESS THAN (UNIX_TIMESTAMP("2017-09-11 00:00:00")),
PARTITION p65 VALUES LESS THAN (UNIX_TIMESTAMP("2017-09-18 00:00:00")),
PARTITION p66 VALUES LESS THAN (UNIX_TIMESTAMP("2017-09-25 00:00:00")),
PARTITION p67 VALUES LESS THAN (UNIX_TIMESTAMP("2017-10-02 00:00:00")),
PARTITION p68 VALUES LESS THAN (UNIX_TIMESTAMP("2017-10-09 00:00:00")),
PARTITION p69 VALUES LESS THAN (UNIX_TIMESTAMP("2017-10-16 00:00:00")),
PARTITION p70 VALUES LESS THAN (UNIX_TIMESTAMP("2017-10-23 00:00:00")),
PARTITION p71 VALUES LESS THAN (UNIX_TIMESTAMP("2017-10-30 00:00:00")),
PARTITION p72 VALUES LESS THAN (UNIX_TIMESTAMP("2017-11-06 00:00:00")),
PARTITION p73 VALUES LESS THAN (UNIX_TIMESTAMP("2017-11-13 00:00:00")),
PARTITION p74 VALUES LESS THAN (UNIX_TIMESTAMP("2017-11-20 00:00:00")),
PARTITION p75 VALUES LESS THAN (UNIX_TIMESTAMP("2017-11-27 00:00:00")),
PARTITION p76 VALUES LESS THAN (UNIX_TIMESTAMP("2017-12-04 00:00:00")),
PARTITION p77 VALUES LESS THAN (UNIX_TIMESTAMP("2017-12-11 00:00:00")),
PARTITION p78 VALUES LESS THAN (UNIX_TIMESTAMP("2017-12-18 00:00:00")),
PARTITION p79 VALUES LESS THAN (UNIX_TIMESTAMP("2017-12-25 00:00:00")),
PARTITION p80 VALUES LESS THAN (UNIX_TIMESTAMP("2018-01-01 00:00:00"))
);
  ';
mysql_query($q);
  
  
$q  = 
"
ALTER TABLE `traffic2`
  ADD PRIMARY KEY (`id`),
  ADD KEY `rdate` (`rdate`),
  ADD KEY `affiliate_id` (`affiliate_id`),
  ADD KEY `merchant_id` (`merchant_id`),
  ADD KEY `product_id` (`product_id`),
  ADD KEY `banner_merchant` (`merchant_id`,`banner_id`),
  ADD KEY `uid` (`uid`);
  ";
  
mysql_query($q);
  

// die();

while ($runThisThing){
echo ($counter+1). ':  ' . ($counter+1)*$rowsInBatch.' Records updated...<br>';
	$runThisThing = false;
	$q = "select id from traffic2 where 1=1 ".$wherePart . "order by id desc limit 1 ;";
	$q = "select id from traffic2 where 1=1 order by id desc limit 1 ;";
	if ($debug)
		echo $q .'<Br>';
	$getMax = mysql_fetch_assoc(mysql_query($q));
	if (empty($getMax['id']))
		$getMax['id'] = 0;
	
	$q = "select id from traffic  where 1=1 ".$wherePart . " order by id desc limit 1 ;";
	if ($debug)
		echo $q .'<Br>';
	$getMaxOrigin = mysql_fetch_assoc(mysql_query($q));
	if ($getMaxOrigin['id'] == $getMax['id'])
		die('Nothing to do, all good...');
		$runThisThing=true;

		
	$q = "INSERT INTO traffic2
SELECT *
FROM traffic where id > " . $getMax['id'] . " 
order by id limit " . ($counter * $rowsInBatch). " , " . $rowsInBatch; 


if ($debug)
echo ($q).'<Br><Br><Br>';

	$counter++;


	mysql_query($q);
	
	$updateUnix = "update traffic2 set unixRdate = unix_timestamp(rdate) where unixRdate = 0;";
	mysql_query($updateUnix);

}

die ('done');


